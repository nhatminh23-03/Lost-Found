name: Deploy to EC2

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    name: SSH deploy → EC2
    runs-on: ubuntu-latest

    steps:
      - name: Debug secrets presence (safe)
        shell: bash
        run: |
          set -e
          if [ -z "${{ secrets.EC2_HOST }}" ]; then echo "Missing EC2_HOST secret"; exit 1; fi
          if [ -z "${{ secrets.EC2_USER }}" ]; then echo "Missing EC2_USER secret"; exit 1; fi
          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then echo "Missing EC2_SSH_KEY secret"; exit 1; fi
          echo "Secrets look present."

      - name: Set up SSH key
        shell: bash
        run: |
          set -e
          mkdir -p "$HOME/.ssh"
          echo "${{ secrets.EC2_SSH_KEY }}" > "$HOME/.ssh/id_rsa"
          chmod 600 "$HOME/.ssh/id_rsa"
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> "$HOME/.ssh/known_hosts"

      - name: Deploy application
        shell: bash
        run: |
          set -e
          ssh -i "$HOME/.ssh/id_rsa" \
              -o StrictHostKeyChecking=yes \
              "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" \
              bash -s << 'REMOTE'
            set -e

            APP_DIR="/home/ubuntu/Lost-Found"
            SERVICE="lostfound"

            echo "── pulling latest code ──"
            cd "$APP_DIR"
            git pull origin main

            echo "── installing dependencies ──"
            source venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            echo "── restarting systemd service ──"
            sudo systemctl restart "$SERVICE"
            sudo systemctl status "$SERVICE" --no-pager
          REMOTE

      - name: Verify service is active
        shell: bash
        run: |
          set -e
          ssh -i "$HOME/.ssh/id_rsa" \
              -o StrictHostKeyChecking=yes \
              "${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}" \
              "sudo systemctl is-active lostfound"